#!/bin/bash

# Default paths
IMPORT_DIR="/mnt/apps/unzip/import"
UNPACKED_DIR="/mnt/apps/unzip/unpacked"

# Load config if it exists
if [ -f /etc/unzipctl.conf ]; then
  . /etc/unzipctl.conf
elif [ -f ~/.unzipctl.conf ]; then
  . ~/.unzipctl.conf
fi

show_help() {
  cat <<EOF

Usage:
  unzipctl import <file1> [file2 ...]
      → Copies one or more files into the import directory.

  unzipctl move <filename> <target_directory> [new_filename]
      → Moves a file from the unpacked directory into a target location.
        Optionally you can rename the file during the move.

  unzipctl import_all
      → Copies all files from the unpacked folder back into the import folder.

  unzipctl cleanup
      → Deletes all files from the import and unpacked directories.

  unzipctl help
      → Shows this help message.

Examples:
  unzipctl import /mnt/apps/weechat-data/xfer/myfile.rar
  unzipctl move myfile.mkv /mnt/tank/movies/newfolder/
  unzipctl move myfile.mkv /mnt/tank/movies/newfolder/ newname.mkv
  unzipctl import_all
  unzipctl cleanup

EOF
}

case "$1" in
  import)
    shift
    if [ $# -eq 0 ]; then
      echo "Error: No files specified."
      exit 1
    fi
    for file in "$@"; do
      echo "Importing $file → $IMPORT_DIR"
      sudo cp "$file" "$IMPORT_DIR"
    done
    ;;

  move)
    FILE="$2"
    TARGET_DIR="$3"
    NEW_NAME="$4"

    if [ -z "$FILE" ] || [ -z "$TARGET_DIR" ]; then
      echo "Error: move requires at least <filename> and <target_directory>."
      show_help
      exit 1
    fi

    if [ -z "$NEW_NAME" ]; then
      echo "Moving $UNPACKED_DIR/$FILE → $TARGET_DIR/$FILE"
      sudo mv "$UNPACKED_DIR/$FILE" "$TARGET_DIR/$FILE"
    else
      echo "Moving $UNPACKED_DIR/$FILE → $TARGET_DIR/$NEW_NAME"
      sudo mv "$UNPACKED_DIR/$FILE" "$TARGET_DIR/$NEW_NAME"
    fi
    ;;

  import_all)
    echo "Copying all files from $UNPACKED_DIR back into $IMPORT_DIR..."
    sudo cp -v "$UNPACKED_DIR"/* "$IMPORT_DIR"/
    ;;

  cleanup)
    echo "Clearing contents of $IMPORT_DIR and $UNPACKED_DIR..."
    sudo rm -rf "$IMPORT_DIR"/*
    sudo rm -rf "$UNPACKED_DIR"/*
    ;;

  help|*)
    show_help
    ;;
esac
